#!/usr/bin/env node

// Test WordPress broadcast generation for existing high-quality document
const Database = require('better-sqlite3');
const crypto = require('crypto');

const db = new Database('./agent/data/db.sqlite');

// Get the bio-concrete document
const DOC_ID = '9b805fc7-43f2-418e-98e3-891291b39ab5';
const doc = db.prepare("SELECT * FROM memories WHERE id = ?").get(DOC_ID);

console.log('üß™ Testing WordPress Broadcast Generation\n');
console.log(`Document: ${DOC_ID.slice(0, 8)}`);
console.log(`Alignment Score: ${doc.alignment_score.toFixed(3)}\n`);

// Create a mock WordPress Insight broadcast (would normally be generated by LLM)
const mockArticle = {
    title: "Bio-Concrete Achieves Breakthrough 52.5 MPa Strength While Sequestering CO2",
    excerpt: "High-strength bio-concrete reaches compressive strength rivaling traditional concrete while sequestering CO2 through optimized aggregate packing and pressure injection techniques.",
    content: `<p>Researchers have achieved a significant breakthrough in sustainable construction materials, developing bio-concrete that matches the strength of traditional concrete while actively sequestering carbon dioxide.</p>

<h2>The Achievement</h2>

<p>The bio-concrete formulation reached 52.5 MPa compressive strength through optimized aggregate packing and pressure injection techniques. This matches or exceeds many conventional concrete applications, making it viable for structural use in buildings and infrastructure.</p>

<h2>How It Works</h2>

<p>The material uses bacterial cultures that precipitate calcium carbonate, filling pores and cracks while consuming CO2. The optimized aggregate packing ensures maximum density and strength, while pressure injection distributes the bacterial solution throughout the concrete matrix.</p>

<h2>Market Implications</h2>

<p>The global concrete market exceeds $600 billion annually, with construction accounting for 8% of global CO2 emissions. This breakthrough could transform one of the world's largest industrial sectors into a carbon sink rather than a major emissions source.</p>

<h2>What's Next</h2>

<p>Commercial pilots are planned for 2026, with researchers focusing on scaling production and reducing costs. The technology could see widespread adoption in sustainable building projects within 5 years.</p>`,
    type: "daily_insight",
    publish_status: "publish"
};

// Create the broadcast
const broadcastId = crypto.randomUUID();
const platforms = ['wordpress_insight'];

for (const platform of platforms) {
    const content = JSON.stringify(mockArticle);
    
    db.prepare(`
        INSERT INTO broadcasts (
            id, documentId, client, content,
            status, alignment_score, image_url, createdAt
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `).run(
        broadcastId,
        DOC_ID,
        platform,
        content,
        'pending',
        doc.alignment_score,
        null,  // No image for test
        Date.now()
    );
    
    console.log(`‚úÖ Created ${platform} broadcast: ${broadcastId.slice(0, 8)}`);
    console.log(`   Title: "${mockArticle.title}"`);
    console.log(`   Content: ${mockArticle.content.length} chars`);
    console.log(`   Status: pending\n`);
}

// Verify it was created
const created = db.prepare("SELECT * FROM broadcasts WHERE id = ?").get(broadcastId);
console.log(`\nüîç Verification:`);
console.log(`   Broadcast ID: ${created.id}`);
console.log(`   Client: ${created.client}`);
console.log(`   Status: ${created.status}`);
console.log(`   Alignment: ${created.alignment_score.toFixed(3)}`);

db.close();

console.log(`\n‚úÖ Test broadcast created successfully!`);
console.log(`\nNext step: Run send script to publish to WordPress:`);
console.log(`   BROADCAST_ID=${broadcastId} node send-pending-to-wordpress.js`);
